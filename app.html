<html>
    <head>
        <script src="jquery-3.2.0.min.js"></script>
        <script src="core/assets/levels/appLevel.js"></script>
        <script src="core/assets/appAssets.js"></script>
        <style type="text/css">
        canvas{
            width: 70%;
            height: 600px;
            float: left;
        }
        #panel{
            display: block;
            float: right;
            width: 30%;
            height: 600px;
            overflow: scroll;
            background: #eee;
        }
        #topbar{
            width: 100%;
        }
        </style>
        <script type="text/javascript">
        $(document).ready(function() {
            cnv = $('canvas')[0];
            ctx = cnv.getContext('2d');
            DRAW_SCALE = 12; // pixels per world unit
            camX = 0; // camera position.
            camY = 0; // ie. the world point to draw at bottom-left.

            $(document).keydown(function(e) {
                if (e.which == 81) { // q
                    DRAW_SCALE -= 1;
                    draw(level);
                }
                else if (e.which == 69) { // e
                    DRAW_SCALE += 1;
                    draw(level);
                }
                else if (e.which == 82) { // r
                    wallMode = !wallMode;
                    if(wallMode) {
                        selected = null;
                        $("#wbutton").val('Switch to: OFF');
                    } else {
                        $("#wbutton").val('Switch to: ON');
                    }
                    draw(level);
                }
                else if (e.which == 46 || e.which == 88) {
                    deleteSelected();
                    draw(level);
                }
                else if (selected != null) {
                    if (e.which == 68) { moveObject(selected, [selected.x + 0.5, selected.y]); draw(level);}
                    else if (e.which == 65) { moveObject(selected, [selected.x - 0.5, selected.y]); draw(level);}
                    else if (e.which == 87) { moveObject(selected, [selected.x , selected.y + 0.5]); draw(level);}
                    else if (e.which == 83) { moveObject(selected, [selected.x , selected.y - 0.5]); draw(level);}
                }
                else if (e.which == 68) { camX += 2; draw(level); }
                else if (e.which == 65) { camX -= 2; draw(level); }
                else if (e.which == 87) { camY += 2; draw(level); }
                else if (e.which == 83) { camY -= 2; draw(level); }

                else if (e.which == 190) { if(selected != null) selected.theta += 5; draw(level); }
                else if (e.which == 188) { if(selected != null) selected.theta -= 5; draw(level); }

                else if (e.which == 191) { if(selected != null && level.food.includes(selected)) {
                    for(var i=0; i < level.food.length; i++) { level.food[i].isDessert=false; }
                    selected.isDessert=true;
                    alert("Set dessert.");
                } }
            });

            $(window).bind('mousewheel DOMMouseScroll', function(event){
                if (event.originalEvent.wheelDelta > 0 || event.originalEvent.detail < 0) {
                    DRAW_SCALE += 1;
                    draw(level);
                }
                else {
                    DRAW_SCALE -= 1;
                    draw(level);
                }
            });

            $('canvas').mousedown(function(e) {
                var screenXY = [e.offsetX, e.offsetY];
                var worldXY = screenToWorld(screenXY);
                prevPos = worldXY;
                if (wallMode) {
                    return;
                }
                for (var i = 0; i < level.food.length; i++) {
                    if (inFood(level.food[i], worldXY)) { selected = level.food[i]; draw(level); return; }
                }
                for (var i = 0; i < level.furniture.length; i++) {
                    if (inFurniture(level.furniture[i], worldXY)) { selected = level.furniture[i]; draw(level); return; }
                }
                for (var i = 0; i < level.walls.length; i++) {
                    if (inWall(level.walls[i], worldXY)) { selected = level.walls[i]; draw(level); return; }
                }
                selected = null;

                draw(level);
                //ctx.fillStyle = '#000';
                //ctx.beginPath(); ctx.arc(screenXY[0], screenXY[1], 1.0, 0, 2*Math.PI, false);
                //ctx.fill();
            });

            $('canvas').mouseup(function(e) {
                mouseUp = true;
                var screenXY = [e.offsetX, e.offsetY];
                var worldXY = screenToWorld(screenXY);
                if (wallMode) {
                    level.walls.push(createNewWall(prevPos, worldXY));
                }
                else if (selected == null) {
                     var xDif = worldXY[0] - prevPos[0];
                     var yDif = worldXY[1] - prevPos[1];
                     camX -= xDif;
                     camY -= yDif;
                }
                else {
                     moveObject(selected, worldXY);
                }
                draw(level);

                //ctx.fillStyle = '#000';
                //ctx.beginPath(); ctx.arc(screenXY[0], screenXY[1], 1.0, 0, 2*Math.PI, false);
                //ctx.fill();
            });

            $( "#wbutton" ).click(function() {
                wallMode = !wallMode;
                if(wallMode) {
                    selected = null;
                    $(this).val('Switch to: OFF');
                } else {
                    $(this).val('Switch to: ON');
                }
            });

            for (var a = 0; a < assets.data.length; a++) {
                var asset = assets.data[a];
                var directory = asset.filename.split('/')[0];
                var imgtag = "<img height='50' src='core/assets/" + asset.filename + "' />";
                var btntag = "<button onclick='update(\"" + directory + "\", \"" + asset.tag + "\")' id='btn" + asset.tag + "'>" + imgtag + "</button>";
                if (directory == 'food') {
                    $('#food').append(btntag);
                } else if (directory == 'furniture') {
                    $('#furniture').append(btntag);
                }
            }

            for (var b = 0; b < level.walls.length; b++) {
                var wall = level.walls[b];
                var tempX = (wall.coords[0] + wall.coords[4]) / 2.0;
                var tempY = (wall.coords[1] + wall.coords[5]) / 2.0;
                wall.x = tempX;
                wall.y = tempY;
            }

            selected = level.furniture[0];
            wallMode = false;
            prevPos = null;
            mouseUp = false;

            draw(level);
        });
        function worldToScreen(xyPair) {
            // note that the canvas draws from the top-left
            worldX = xyPair[0];
            worldY = xyPair[1];
            screenX = (worldX-camX) * DRAW_SCALE;
            screenY = cnv.height - (worldY-camY) * DRAW_SCALE;
            return [screenX, screenY];
        }
        function screenToWorld(xyPair) {
            screenX = xyPair[0];
            screenY = xyPair[1];
            worldX = camX + screenX / DRAW_SCALE;
            worldY = camY - (screenY - cnv.height) / DRAW_SCALE;
            return [worldX, worldY];
        }
        function inFurniture(item, xyPair) {
            // in world coordinates
            if (item.radius > 0) {
                return (item.x - xyPair[0])**2 + (item.y - xyPair[1])**2 < item.radius**2;
            }
            else {
                var dx = xyPair[0] - item.x; var dy = xyPair[1] - item.y;
                // switch to local coordinates relative to center of rotated rectangle
                var du = Math.cos(item.theta)*dx + Math.sin(item.theta)*dy;
                var dv = -Math.sin(item.theta)*dx + Math.cos(item.theta)*dy;

                return (du > -0.5*item.width) && (du < 0.5*item.width)
                    && (dv > - 0.5*item.height) && (dv < 0.5*item.height);
            }
        }
        function inFood(item, xyPair) { return inFurniture(item, xyPair); }
        function inWall(item, xyPair) { return inPolygon(item.coords, xyPair); }

        function moveObject(selected, newPos) {
            if (selected != null) {
                if (selected.tags[0] == "wall") {
                    var xDif = newPos[0] - selected.x;
                    var yDif = newPos[1] - selected.y;
                    selected.coords[0] += xDif;
                    selected.coords[2] += xDif;
                    selected.coords[4] += xDif;
                    selected.coords[6] += xDif;
                    selected.coords[1] += yDif;
                    selected.coords[3] += yDif;
                    selected.coords[5] += yDif;
                    selected.coords[7] += yDif;
                }
                selected.x = newPos[0]
                selected.y = newPos[1]
            }
        }

        function createNewWall(xyPrev, xy) {
            var x1 = xyPrev[0];
            var y1 = xyPrev[1];
            var x2 = xy[0];
            var y2 = xy[1];
            var x = (x1 + x2) / 2.0;
            var y = (y1 + y2) / 2.0;
            var wall = {"coords": [x1,y1,x1,y2,x2,y2,x2,y1], "tags": ["wall"], "x" : x, "y" : y};
            return wall;
        }

        function drawWall(wall, color) {
            ctx.fillStyle = '#555';
            ctx.strokeStyle = color;
            ctx.beginPath();
            var first = worldToScreen([wall.coords[0], wall.coords[1]]);
            var second = worldToScreen([wall.coords[2], wall.coords[3]]);
            var third = worldToScreen([wall.coords[4], wall.coords[5]]);
            var fourth = worldToScreen([wall.coords[6], wall.coords[7]]);
            ctx.moveTo(first[0], first[1]);
            ctx.lineTo(second[0], second[1]);
            ctx.lineTo(third[0], third[1]);
            ctx.lineTo(fourth[0], fourth[1]);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        function drawFood(item, color) {
            drawFurniture(item, color);
        }
        function drawFurniture(item, color) {
            tag = item.tags[0];
            xy = worldToScreen([item.x, item.y]); // position of the item center
            xytl = worldToScreen([item.x - item.radius, item.y + item.radius]); // position of item top-left
            img = $('#btn'+tag).children('img')[0];
            ctx.strokeStyle = color;
            asset = null;
            for (var i = 0; i < assets.data; i++) {
                if (assets.data[i].tag == tag) {asset = assets.data[i];}
            }
            ctx.beginPath();
            if (item.radius > 0) {
                ctx.drawImage(img, xytl[0], xytl[1], item.radius*2*DRAW_SCALE, item.radius*2*DRAW_SCALE);
                ctx.arc(xy[0], xy[1], item.radius*DRAW_SCALE, 0, 2*Math.PI, false);
            }
            else {
                // rect function is top-left-x, top-left-y, width, height.
                xytl = worldToScreen([item.x-item.width/2, item.y+item.height/2]);
                //ctx.translate(DRAW_SCALE*xytl[0], DRAW_SCALE*xytl[1]);
                //ctx.rotate(-item.theta*Math.PI/180.0);
                ctx.drawImage(img, xytl[0], xytl[1], item.width*DRAW_SCALE, item.height*DRAW_SCALE);
                ctx.rect(xytl[0], xytl[1], item.width*DRAW_SCALE, item.height*DRAW_SCALE);
                //ctx.rotate(item.theta*Math.PI/180.0);
                //ctx.translate(-DRAW_SCALE*xytl[0],-DRAW_SCALE*xytl[1]);
            }
            ctx.stroke();
        }
        function draw(levelObject) {
            cnv.width = $('canvas').width();
            cnv.height = $('canvas').height();
            ctx.fillStyle = '#fff';
            ctx.clearRect(0,0,cnv.width,cnv.height);
            walls = levelObject.walls;
            for(var w = 0; w < walls.length; w++) {
                drawWall(walls[w], '#ff0');
            }
            food = levelObject.food;
            for (var f = 0; f < food.length; f++) {
                drawFood(food[f], '#ff0');
            }
            furniture = levelObject.furniture;
            for (var f = 0; f < furniture.length; f++) {
                drawFurniture(furniture[f], '#ff0');
            }
            if (selected != null) {
                if (selected.coords == undefined) { drawFurniture(selected, '#00f'); }
                else { drawWall(selected, '#00f'); }
            }
        }
        function deleteSelected() {
            if (selected == null) return;
            for (var i = 0; i < level.furniture.length; i++) {
                if (level.furniture[i] == selected) { selected = null; level.furniture.splice(i,1); }
            }
            for (var i = 0; i < level.food.length; i++) {
                if (level.food[i] == selected) { selected = null; level.food.splice(i,1); }
            }
            for (var i = 0; i < level.walls.length; i++) {
                if (level.walls[i] == selected) { selected = null; level.walls.splice(i,1); }
            }
        }
        function update(type, newtag) {
            if ((selected != null) &&
                ((type=='furniture' && level.furniture.includes(selected)) ||
                (type == 'food' && level.food.includes(selected)) ||
                (type == 'wall' && level.walls.includes(selected)))) {
                selected.tags[0] = newtag;
            }
            else {
                // add a new one!
                if (type == 'furniture') { level.furniture.push({"x": 25, "y": 25, "width": 6, "height": 4.7, "radius": 0, "theta": 0, "tags": [newtag]}); selected = level.furniture[level.furniture.length-1]; }
                if (type == 'food') { level.food.push({"x": 25, "y": 25, "radius": 1, "theta": 0, "tags": [newtag], "dessert": false, "amount": 10}); selected = level.food[level.food.length-1]; }
            }
            draw(level);
        }
        function inPolygon(coords, xyPair) {
            var windingangle = 0;
            windingangle += subtended(xyPair[0], xyPair[1], coords[0], coords[1], coords[2], coords[3]);
            windingangle += subtended(xyPair[0], xyPair[1], coords[2], coords[3], coords[4], coords[5]);
            windingangle += subtended(xyPair[0], xyPair[1], coords[4], coords[5], coords[6], coords[7]);
            windingangle += subtended(xyPair[0], xyPair[1], coords[6], coords[7], coords[0], coords[1]);
            if (Math.abs(windingangle) > 0.1) {return true;} else {return false;}
        }
        function subtended(x, y, ax, ay, cx, cy) {
            ax -= x; ay -= y; cx -= x; cy -= y;
            var bx = cx-ax; var by = cy-ay;
            var alen = Math.sqrt(ax**2+ay**2);
            var bdota = ax*bx+ay*by;
            var Dx = alen + bdota / alen;
            var Dyx = bx - bdota*ax/(alen*alen);
            var Dyy = by - bdota*ay/(alen*alen);
            var Dy = Math.sqrt(Dyx**2 + Dyy**2);
            var th =  Math.atan2(Dy, Dx);
            var sign = Math.sign(ax*by - ay*bx);
            return th*sign;
        }
        </script>
    </head>
    <body>
        <div id="topbar">
            <input type="file" id="file"/>
            <input type="button" value="Load" id="load"/>
            <input type="button" value="Save" id="save"/>
        </div>
        <canvas></canvas>
        <div id="panel">
            <h2>Food</h2>
            <div id="food"></div>
            <h2>Furniture</h2>
            <div id="furniture"></div>
            <h2>Walls</h2>
            <div id="walls">
                <input id="wbutton" type="button" value='Switch to: ON'>
            </div>
        </div>
        <p>WASD to maneuver level or furniture if selected. q/e to zoom in and out. r to switch to wall mode. x or delete to delete object. ,/. to  rotate an object. / to mark dessert.</p>
    </body>
</html>